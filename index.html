<!doctype html>
<html>
    <head>
        <title>Chatroom</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript">
        'use strict';
        var socket = io();

        // Choose username & set in localStorage
        var username;
        if ('localStorage' in window && localStorage.getItem('username')) {
            username = localStorage.getItem('username');
        } else {
            username = window.prompt('Hi! To enter Chatroom, choose a username.');
            if ('localStorage' in window) {
                localStorage.setItem('username', username);
            }
        }

        socket.emit('join', username);

        $(document).ready(() => {
            // Send a message
            $('form').submit((e) => {
                e.preventDefault();

                var msg = $('#writeMsg').val();
                socket.emit('message', msg);

                $('#writeMsg').val('');
            });

            // Receive message
            socket.on('message', (msg, username) => {
                addUserMsg(msg, username);
            });

            // Receive disconnect message
            socket.on('disconnect', (username, time) => {

                if (username === 'transport close' && time === undefined) {
                    return; // Ignore server restart (and fail) messages
                }

                var unit = (time === 1) ? 'second' : 'seconds';
                addAutoMsg(`${username} left after ${time} ${unit}.`);
            });

            // Receive join message
            socket.on('join', (username) => {
                addAutoMsg(`${username} joined`);
            });
        });

        // Generic functions to add to messages
        function addToMessages (msgElement) {
            $('#messages').append(msgElement);
        }

        function addAutoMsg (msg) {
            var msgElement = $('<li class="autoMsg">').html(msg);
            addToMessages(msgElement);
        }

        function addUserMsg (msg, byUser) {
            if (byUser === username) {
                byUser = 'You';
            }

            var content = `<span class="username">${byUser}:</span> ${msg}`;
            var msgElement = $('<li>').html(content);
            addToMessages(msgElement);
        }
    </script>
    <body>
        <ul id="messages">
        </ul>
        <form id="sendForm" action="">
            <input id="writeMsg" autocomplete="off" autofocus />
            <button id="sendMsg">Send</button>
        </form>
    </body>
</html>
